<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dark Playlist Player</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
  .container { display:flex; height:100vh; }
  .left-panel { flex:1; background:#1a1a1a; padding:20px; box-sizing:border-box; display:flex; flex-direction:column; }
  .right-panel { flex:2; background:#181818; padding:20px; box-sizing:border-box; overflow-y:auto; }
  #player-container { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  #player { width:75%; height:200px; background:#000; }
  #quality { background:#1e1e1e; color:#fff; border:1px solid #333; border-radius:6px; padding:6px; }
  .input-row { display:flex; gap:10px; margin:10px 0; }
  .input-row input { flex:1; padding:8px; background:#1e1e1e; color:#fff; border:1px solid #333; border-radius:6px; }
  .load-btn {
    background-color:#7a3cff; border:none; border-radius:25px;
    padding:8px 16px; color:#fff; font-weight:bold; cursor:pointer;
    box-shadow:0 0 8px rgba(122,60,255,0.6); transition:background .2s, box-shadow .2s;
  }
  .load-btn:hover { background:#5e2fcc; box-shadow:0 0 12px rgba(122,60,255,0.9); }
  .controls { display:flex; justify-content:space-around; margin:10px 0; }
  .controls button {
    background-color: #7a3cff; border:none; border-radius:50%;
    width:45px; height:45px; color:#fff; font-size:18px; cursor:pointer;
    box-shadow:0 0 8px rgba(122,60,255,0.6); transition:background-color .2s, box-shadow .2s;
  }
  .controls button:hover { background:#5e2fcc; box-shadow:0 0 12px rgba(122,60,255,0.9); }
  .volume-control { display:flex; align-items:center; gap:10px; margin:15px 0; }
  .volume-control i { font-size:18px; color:#fff; }
  .volume-control input[type="range"] {
    -webkit-appearance:none; width:100%; height:6px; background:#333; border-radius:3px; outline:none; cursor:pointer;
  }
  .volume-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:#7a3cff;
    box-shadow:0 0 6px rgba(122,60,255,0.8); cursor:pointer; transition:background .2s;
  }
  .volume-control input[type="range"]::-webkit-slider-thumb:hover { background:#5e2fcc; }
  .volume-control span { min-width:40px; text-align:right; }
  .playlist-item { padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .playlist-item:hover { background:#2a2a2a; }
  .playlist-item.active { background:#3a1f6e; box-shadow:inset 0 0 8px rgba(122,60,255,0.8); }
  .track-info { display:flex; flex-direction:column; }
  .track-number { color:#aaa; font-size:12px; }
  .muted { color:#aaa; font-size:12px; }
</style>
</head>
<body>

<div class="container">
  <div class="left-panel">
    <div id="player-container">
      <div id="player"></div>
      <select id="quality">
        <option value="small">240p</option>
        <option value="medium" selected>360p</option>
        <option value="hd720">720p</option>
        <option value="hd1080">1080p</option>
      </select>
    </div>
    <div class="input-row">
      <input id="playlistUrl" placeholder="Incolla il link della playlist">
      <button id="loadBtn" class="load-btn"><i class="fa-solid fa-cloud-arrow-down"></i> Carica</button>
    </div>
    <div class="controls">
      <button id="prevBtn" title="Precedente"><i class="fa-solid fa-backward-step"></i></button>
      <button id="playBtn" title="Play/Pausa"><i class="fa-solid fa-play"></i></button>
      <button id="nextBtn" title="Successivo"><i class="fa-solid fa-forward-step"></i></button>
      <button id="shuffleBtn" title="Shuffle"><i class="fa-solid fa-shuffle"></i></button>
    </div>
    <div class="volume-control">
      <i id="volumeIcon" class="fa-solid fa-volume-high"></i>
      <input id="volSlider" type="range" min="0" max="100" value="100" step="1">
      <span id="volPercent">100%</span>
    </div>
    <div id="status" class="muted"></div>
  </div>

  <div class="right-panel" id="playlistInfo"></div>
</div>

<script>
  const apiKey = "AIzaSyDDvrky0zFKo-Vs_HY5DaaVTrlXL397wz4"; // <-- INSERISCI QUI LA TUA API KEY
  let player, playlistId = "", shuffle = false, savedQuality = "medium";

  (function loadYT() {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  })();

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '200',
      width: '100%',
      playerVars: { modestbranding: 1, rel: 0, playsinline: 1, enablejsapi: 1, origin: location.origin },
      events: { 
        onReady: onPlayerReady,
        onStateChange: (e) => {
          if (e.data === YT.PlayerState.PLAYING) {
            highlightCurrentVideo();
          }
        }
      }
    });
  }

  function onPlayerReady() {
    player.setPlaybackQuality(savedQuality);
    player.setVolume(100);
    console.log("âœ… Player pronto");
  }

  function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
  function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  document.getElementById('loadBtn').addEventListener('click', loadPlaylist);
  document.getElementById('prevBtn').addEventListener('click', () => player.previousVideo());
  document.getElementById('nextBtn').addEventListener('click', () => player.nextVideo());
  document.getElementById('shuffleBtn').addEventListener('click', () => { shuffle = !shuffle; setStatus("Shuffle: " + (shuffle ? "On" : "Off")); });
  document.getElementById('quality').addEventListener('change', e => {
    savedQuality = e.target.value;
    player.setPlaybackQuality(savedQuality);
  });
  document.getElementById('volSlider').addEventListener('input', e => {
    const v = +e.target.value;
    player.setVolume(v);
    document.getElementById('volPercent').innerText = v + "%";
    const icon = document.getElementById('volumeIcon');
    icon.className = "fa-solid";
    if (v === 0) icon.classList.add('fa-volume-xmark');
    else if (v > 0 && v <= 30) icon.classList.add('fa-volume-off');
    else if (v > 30 && v <= 70) icon.classList.add('fa-volume-low');
    else icon.classList.add('fa-volume-high');
  });
  document.getElementById('playBtn').addEventListener('click', () => {
    const icon = document.querySelector('#playBtn i');
    if
    if (player.getPlayerState() === YT.PlayerState.PLAYING) {
      player.pauseVideo();
      icon.classList.replace('fa-pause', 'fa-play');
    } else {
      player.playVideo();
      icon.classList.replace('fa-play', 'fa-pause');
    }
  });

  function loadPlaylist() {
    setStatus("");
    const url = document.getElementById('playlistUrl').value.trim();
    const idMatch = url.match(/[?&]list=([a-zA-Z0-9_-]+)/);
    if (!idMatch) { 
      setStatus("Link playlist non valido."); 
      return; 
    }
    playlistId = idMatch[1];

    fetchAllPlaylistItems(playlistId).then(items => {
      console.log("ðŸ“¦ Video totali trovati:", items.length);
      const videoIds = items.map(i => i.contentDetails.videoId).filter(Boolean);

      fetchVideosMeta(videoIds).then(meta => {
        const filteredIds = videoIds.filter(id => meta[id]?.embeddable);
        console.log("âœ… Video embeddabili:", filteredIds.length);

        if (shuffle) shuffleArray(filteredIds);

        if (filteredIds.length > 0) {
          player.loadPlaylist({ playlist: filteredIds, index: 0 });
          renderPlaylistUI(items, meta);
          setStatus(`Caricati ${filteredIds.length} video embeddabili su ${videoIds.length}`);
        } else {
          setStatus("Nessun video embeddabile trovato.");
        }
      });
    });
  }

  function fetchAllPlaylistItems(id) {
    let pageToken = "", items = [];
    function fetchPage() {
      const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=50&playlistId=${id}&key=${apiKey}${pageToken ? `&pageToken=${pageToken}` : ""}`;
      return fetch(url).then(res => res.json()).then(data => {
        if (data.items) items.push(...data.items);
        if (data.nextPageToken) {
          pageToken = data.nextPageToken;
          return fetchPage();
        }
      });
    }
    return fetchPage().then(() => items);
  }

  function fetchVideosMeta(videoIds) {
    const out = {};
    let i = 0;
    function fetchBatch() {
      if (i >= videoIds.length) return Promise.resolve(out);
      const batch = videoIds.slice(i, i + 50).join(',');
      i += 50;
      const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,status&id=${batch}&key=${apiKey}`;
      return fetch(url).then(res => res.json()).then(data => {
        (data.items || []).forEach(v => {
          const id = v.id;
          const status = v.status || {};
          const contentDetails = v.contentDetails || {};
          out[id] = {
            embeddable: !!status.embeddable,
            duration: formatDuration(contentDetails.duration)
          };
        });
        return fetchBatch();
      });
    }
    return fetchBatch();
  }

  function formatDuration(iso) {
    const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    const h = +(m?.[1] || 0), min = +(m?.[2] || 0), s = +(m?.[3] || 0);
    const hh = h > 0 ? h + ":" : "";
    return hh + String(min).padStart(2, '0') + ":" + String(s).padStart(2, '0');
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function renderPlaylistUI(items, meta) {
    const container = document.getElementById('playlistInfo');
    container.innerHTML = '';
    items.forEach((item, idx) => {
      const id = item.contentDetails.videoId;
      const title = item.snippet.title;
      const duration = meta[id]?.duration || '';
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.dataset.id = id;
      div.innerHTML = `
        <div class="track-info">
          <strong>${escapeHtml(title)}</strong>
          <span class="track-number">#${idx + 1}</span>
        </div>
        <span>${duration}</span>
      `;
      div.addEventListener('click', () => {
        const current = player.getPlaylist() || [];
        const pos = current.indexOf(id);
        if (pos >= 0) {
          player.playVideoAt(pos);
        }
      });
      container.appendChild(div);
    });
  }

  function highlightCurrentVideo() {
    const currentId = player.getVideoData().video_id;
    document.querySelectorAll('.playlist-item').forEach(el => {
      if (el.dataset.id === currentId) {
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        el.classList.remove('active');
      }
    });
  }
</script>

</body>
</html>
