<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>simple-yt-player-v1</title>
  <style>
    html, body {
      margin:0; padding:0; height:100%;
      overflow:hidden;
      font-family:system-ui,Arial,sans-serif;
      background:#121212; color:#f0f0f0;
    }
    .wrap {
      height:100vh; max-width:1400px; margin:0 auto; padding:20px;
      display:grid; grid-template-columns:1fr 1fr; gap:40px;
      box-sizing:border-box;
    }
    header { grid-column:1/-1; text-align:center; margin-bottom:10px; }
    h1 { margin:8px 0; font-size:2rem; color:#bb86fc; font-weight:600; }
    .player {
      background:#000; border-radius:12px; overflow:hidden;
      box-shadow:0 2px 12px rgba(0,0,0,0.5);
      margin-bottom:10px; width:90%; height:30vh;
      margin-left:auto; margin-right:auto;
    }
    .controls {
      margin:12px 0; display:flex; align-items:center; gap:14px; justify-content:center;
    }
    button {
      background:#1e1e1e; border:2px solid #333; border-radius:50%;
      width:48px; height:48px; display:flex; align-items:center; justify-content:center;
      color:#ddd; cursor:pointer; transition:all 0.2s ease;
      box-shadow:0 0 6px rgba(0,0,0,0.6);
    }
    button:hover { background:#2f2f2f; border-color:#555; color:#fff; }
    button.active { border-color:#bb86fc; background:#2a2250; color:#bb86fc; box-shadow:0 0 10px #bb86fc; }
    input[type=range]{padding:0;cursor:pointer}
    .list {
      margin-top:10px; overflow:auto; height:calc(100vh - 220px);
      font-size:1rem; border:1px solid #222; border-radius:10px;
      background:#181818; padding:10px;
    }
    .track { padding:8px 12px; cursor:pointer; border-bottom:1px solid #222; transition:background 0.15s; }
    .track:hover { background:#2a2a2a; }
    .track.active { background:#3a264d; }
    #timeRow, #volumeRow { display:flex; align-items:center; gap:10px; margin-top:6px; }
    #timeRow input, #volumeRow input { flex:1; }
    #timeLabel, #volLabel { font-size:0.9rem; color:#aaa; min-width:70px; text-align:right; }
    #loadingIndicator { display:none; font-size:0.9rem; color:#bbb; align-self:center; }
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>simple-yt-player-v1</h1>
    </header>

    <!-- Colonna sinistra: Player -->
    <div>
      <div class="player" id="player"></div>
      <div id="timeRow">
        <input id="seek" type="range" min="0" max="100" value="0">
        <span id="timeLabel">0:00 / 0:00</span>
      </div>
      <div class="controls">
        <button id="btnPrev" title="Indietro"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button id="btnPlay" title="Play/Pausa"><svg id="iconPlay" width="26" height="26" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
        <button id="btnNext" title="Avanti"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M16 18h2V6h-2M6 18l8.5-6L6 6v12z"/></svg></button>
        <button id="btnShuffle" title="Shuffle OFF"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h4v4h-2V5h-2V3zm0 14h2v-2h2v4h-4v-2zM3 5h6l7 7-7 7H3v-2h5.17L14 12 8.17 7H3V5z"/></svg></button>
      </div>
      <div id="volumeRow">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>
        <input id="vol" type="range" min="0" max="100" value="75">
        <span id="volLabel">75%</span>
      </div>
    </div>

    <!-- Colonna destra: Playlist -->
    <div>
      <div style="display:flex;gap:10px;margin-bottom:8px;align-items:center">
        <input id="playlistUrl" type="text" placeholder="Playlist URL..." style="flex:1;padding:10px;border-radius:6px;border:1px solid #333;background:#1e1e1e;color:#eee">
        <button id="loadBtn" title="Carica Playlist">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2zm-7 8l-5-5h3V4h4v12h3l-5 5z"/></svg>
        </button>
        <span id="loadingIndicator">Caricamento...</span>
      </div>
      <div id="playlistTitle"></div>
      <div class="list" id="tracksList"></div>
    </div>
  </div>

<script>
const API_KEY = 'AIzaSyDDvrky0zFKo-Vs_HY5DaaVTrlXL397wz4';
const MAX_RESULTS = 50;
let playlistId=null, player=null, totalResults=0;
let shuffleEnabled=false;
let shuffleOrder=[], shuffleIndex=0;

function extractPlaylistId(str){
  try { const u=new URL(str); return u.searchParams.get('list'); }
  catch(e){ return null; }
}

function initShuffleOrder(){
  const tracks=document.querySelectorAll('#tracksList .track');
  shuffleOrder=Array.from(tracks.keys());
  for(let k=shuffleOrder.length-1;k>0;k--){
    const r=Math.floor(Math.random()*(k+1));
    [shuffleOrder[k], shuffleOrder[r]]=[shuffleOrder[r], shuffleOrder[k]];
  }
  shuffleIndex=0;
}
function playNextRandomUnique(){
  const tracks=document.querySelectorAll('#tracksList .track');
  if(shuffleOrder.length===0 || shuffleIndex>=shuffleOrder.length){ initShuffleOrder(); }
  const idx=shuffleOrder[shuffleIndex++];
  tracks[idx].click();
}
function getActiveTrack(){ return document.querySelector('.track.active'); }
function playNextSequential(){ const a=getActiveTrack(); if(a&&a.nextElementSibling) a.nextElementSibling.click(); }

async function loadPlaylist(){
  playlistId=extractPlaylistId(document.getElementById('playlistUrl').value.trim());
  if(!playlistId)return alert('Playlist non valida');
  document.getElementById('loadingIndicator').style.display='inline';

  let allItems=[], seenIds=new Set(), pageToken='';
  do {
    const url=new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    url.searchParams.set('part','snippet');
    url.searchParams.set('playlistId',playlistId);
    url.searchParams.set('maxResults',MAX_RESULTS);
    url.searchParams.set('key',API_KEY);
    if(pageToken)url.searchParams.set('pageToken',pageToken);

    const res=await fetch(url);
    const data=await res.json();
    (data.items||[]).forEach(it=>{
      const vid=it.snippet      const vid=it.snippet.resourceId.videoId;
      if(!seenIds.has(vid)){
        seenIds.add(vid);
        allItems.push(it);
      }
    });
    pageToken=data.nextPageToken||'';
  } while(pageToken);

  totalResults=allItems.length;
  document.getElementById('playlistTitle').textContent=`Totale: ${totalResults} brani`;

  const list=document.getElementById('tracksList');
  list.innerHTML='';
  allItems.forEach((it, idx) => {
    const vid = it.snippet.resourceId.videoId;
    const div = document.createElement('div');
    div.className = 'track';
    div.textContent = (idx+1) + ". " + it.snippet.title;
    div.dataset.videoId = vid;
    div.onclick = () => playVideo(vid, div);
    list.appendChild(div);
  });

  initShuffleOrder();
  document.getElementById('loadingIndicator').style.display='none';
}

// Riproduzione video
function playVideo(id,el){
  document.querySelectorAll('.track').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  if(!player){
    player=new YT.Player('player',{
      width:'100%',height:'100%',videoId:id,
      playerVars:{controls:0,modestbranding:1,rel:0,origin:location.origin},
      events:{
        onReady:()=>{
          player.setPlaybackQuality('medium');
          setInterval(()=>player.setPlaybackQuality('medium'),2000);
        },
        onStateChange:(e)=>{
          player.setPlaybackQuality('medium');
          if(e.data === YT.PlayerState.ENDED){
            if(shuffleEnabled){
              playNextRandomUnique();
            } else {
              playNextSequential();
            }
          }
        },
        onError:e=>{
          if([101,150,153].includes(e.data)) el?.nextElementSibling?.click();
        }
      }
    });
  } else {
    player.loadVideoById(id);
    player.setPlaybackQuality('medium');
    setInterval(()=>player.setPlaybackQuality('medium'),2000);
  }
}

// Controlli
document.getElementById('btnPlay').onclick=()=>{
  if(!player)return;
  const s=player.getPlayerState();
  const icon=document.getElementById('iconPlay').firstElementChild;
  if(s===YT.PlayerState.PLAYING){
    player.pauseVideo();
    icon.setAttribute('d','M6 19h4V5H6zm8-14v14h4V5h-4z'); // pausa
  } else {
    player.playVideo();
    icon.setAttribute('d','M8 5v14l11-7z'); // play
  }
};
document.getElementById('btnPrev').onclick=()=>playNextSequential();
document.getElementById('btnNext').onclick=()=>playNextSequential();

// Shuffle toggle
document.getElementById('btnShuffle').onclick=()=>{
  shuffleEnabled=!shuffleEnabled;
  const btn=document.getElementById('btnShuffle');
  btn.classList.toggle('active', shuffleEnabled);
  btn.title = shuffleEnabled ? 'Shuffle ON: riproduzione casuale' : 'Shuffle OFF: riproduzione sequenziale';
};

// Volume e seek
document.getElementById('vol').oninput=e=>{
  if(player) player.setVolume(e.target.value);
  document.getElementById('volLabel').textContent=e.target.value+'%';
};
document.getElementById('seek').oninput=e=>{
  if(player){
    const d=player.getDuration();
    player.seekTo(d*e.target.value/100,true);
  }
};
setInterval(()=>{
  try{
    if(player){
      const c=player.getCurrentTime(),d=player.getDuration();
      document.getElementById('seek').value=d?c/d*100:0;
      document.getElementById('timeLabel').textContent=
        `${Math.floor(c/60)}:${String(Math.floor(c%60)).padStart(2,'0')} / ${Math.floor(d/60)}:${String(Math.floor(d%60)).padStart(2,'0')}`;
    }
  }catch{}
},500);

document.getElementById('loadBtn').onclick=loadPlaylist;

// Carica API YouTube
(function(){
  const tag=document.createElement('script');
  tag.src="https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
})();
</script>
</body>
</html>
