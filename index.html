<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Playlist Player - Lightweight</title>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#121212;color:#f0f0f0;line-height:1.4}
    .wrap{max-width:900px;margin:0 auto;padding:16px;display:grid;grid-template-columns:320px 1fr;gap:20px}
    header{grid-column:1/-1;text-align:center;margin-bottom:12px}
    h1{margin:4px 0;font-size:1.6rem;color:#bb86fc;font-weight:600}
    p{margin:0;font-size:0.9rem;color:#aaa}
    .player{background:#000;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
    .controls{margin-top:10px;font-size:1rem;display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center}
    button,input,select{background:#1e1e1e;color:#ddd;border:1px solid #333;border-radius:6px;padding:8px 12px;font-size:1rem;cursor:pointer;transition:background 0.2s}
    button:hover,select:hover,input[type=range]:hover{background:#2a2a2a}
    button{min-width:46px;min-height:42px}
    input[type=range]{padding:0;cursor:pointer}
    .list{margin-top:12px;overflow:auto;max-height:460px;font-size:0.9rem;border:1px solid #222;border-radius:8px;background:#181818}
    .track{padding:8px 10px;cursor:pointer;border-bottom:1px solid #222;transition:background 0.15s}
    .track:hover{background:#2a2a2a}
    .track.active{background:#3a264d}
    .pages{display:flex;gap:6px;margin:8px 0;font-size:0.85rem;flex-wrap:wrap;justify-content:center}
    .pages button{padding:5px 10px}
    #playlistInfo{margin-top:6px;font-size:0.9rem;color:#bbb}
    #playlistTitle{margin-top:6px;font-size:1rem;color:#fff;font-weight:500;text-align:center}
    #timeLabel{font-size:0.85rem;color:#aaa;margin-top:4px;text-align:center}
    @media(max-width:800px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>YouTube Music Player</h1>
      <p>Mini-player ottimizzato per prestazioni. Mostra max 50 brani per pagina.</p>
      <div id="playlistInfo"></div>
    </header>

    <div>
      <div class="player" id="player"></div>
      <div class="controls">
        <button id="btnPrev">‚èÆ</button>
        <button id="btnPlay">‚ñ∂Ô∏è/‚è∏</button>
        <button id="btnNext">‚è≠</button>
        <button id="btnRepeat">üîÅ</button>
        <button id="btnShuffle">üîÄ</button>
        <input id="seek" type="range" min="0" max="100" value="0">
        <input id="vol" type="range" min="0" max="100" value="75">
        <span id="volLabel">75%</span>
        <select id="quality">
          <option value="small">144p</option>
          <option value="medium">360p</option>
          <option value="large">480p</option>
          <option value="hd720">720p</option>
        </select>
      </div>
      <div id="timeLabel">0:00 / 0:00</div>
    </div>

    <div>
      <div style="display:flex;gap:6px;margin-bottom:6px">
        <input id="playlistUrl" type="text" placeholder="Playlist URL..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #333;background:#1e1e1e;color:#eee">
        <button id="loadBtn">Carica</button>
      </div>
      <div id="playlistTitle"></div>
      <div class="pages" id="pages"></div>
      <div class="list" id="tracksList"></div>
    </div>
  </div>

<script>
  const API_KEY = 'AIzaSyDDvrky0zFKo-Vs_HY5DaaVTrlXL397wz4';
  const MAX_RESULTS = 50;

  let playlistId = null;
  let player = null;
  let isRepeating = false;
  let isShuffled = false;
  let pageCache = {};
  let pageTokens = [];
  let totalTracks = 0;
  let playlistTitle = '';

  // Estrae l‚ÄôID playlist da un URL o da stringa
  function extractPlaylistId(str) {
    try {
      const u = new URL(str);
      if (u.searchParams.get('list')) return u.searchParams.get('list');
    } catch (e) {}
    const m = str.match(/list=([A-Za-z0-9_-]+)/);
    return m ? m[1] : null;
  }

  // Fetch di una singola pagina di playlistItems
  async function fetchPage(pageToken = '') {
    const url = new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    url.searchParams.set('part', 'snippet');
    url.searchParams.set('playlistId', playlistId);
    url.searchParams.set('maxResults', MAX_RESULTS);
    url.searchParams.set('key', API_KEY);
    if (pageToken) url.searchParams.set('pageToken', pageToken);
    const res = await fetch(url);
    return res.json();
  }

  // Fetch del titolo della playlist
  async function fetchPlaylistTitle() {
    const url = new URL('https://www.googleapis.com/youtube/v3/playlists');
    url.searchParams.set('part', 'snippet');
    url.searchParams.set('id', playlistId);
    url.searchParams.set('key', API_KEY);
    const res = await fetch(url);
    const data = await res.json();
    return (data.items && data.items[0] && data.items[0].snippet.title) || '';
  }

  // Fetch degli ID embeddabili
  async function fetchEmbeddableIds(ids) {
    const emb = [];
    for (let i = 0; i < ids.length; i += 50) {
      const batch = ids.slice(i, i + 50).join(',');
      const res = await fetch(
        `https://www.googleapis.com/youtube/v3/videos?part=status&id=${batch}&key=${API_KEY}`
      );
      const data = await res.json();
      (data.items || []).forEach(v => {
        if (v.status && v.status.embeddable) emb.push(v.id);
      });
    }
    return emb;
  }

  // Carica tutta la playlist e filtra i video embeddabili
  async function loadPlaylist() {
    playlistId = extractPlaylistId(
      document.getElementById('playlistUrl').value.trim()
    );
    if (!playlistId) {
      alert('Playlist non valida');
      return;
    }

    // reset stati
    pageCache = {};
    pageTokens = [];
    totalTracks = 0;
    document.getElementById('tracksList').innerHTML = '';
    document.getElementById('pages').innerHTML = 'Caricamento...';
    document.getElementById('playlistInfo').textContent = '';
    document.getElementById('playlistTitle').textContent = '';

    // fetching paginato
    let token = '';
    do {
      const d = await fetchPage(token);
      if (!d.items || !d.items.length) break;
      pageCache[token] = { items: d.items, next: d.nextPageToken || null };
      pageTokens.push(token);
      totalTracks += d.items.length;
      token = d.nextPageToken || '';
    } while (token);

    // titolo e conteggio totale
    playlistTitle = await fetchPlaylistTitle();
    document.getElementById('playlistTitle').textContent = playlistTitle;

    // raccolta di tutti gli ID video e filtro embeddabili
    const allIds = pageTokens.flatMap(t =>
      pageCache[t].items.map(it => it.snippet.resourceId.videoId)
    );
    const embeddable = await fetchEmbeddableIds(allIds);

    // applica il filtro alle pagine
    pageTokens.forEach(t => {
      pageCache[t].items = pageCache[t].items.filter(it =>
        embeddable.includes(it.snippet.resourceId.videoId)
      );
    });

    totalTracks = pageTokens.reduce(
      (sum, t) => sum + pageCache[t].items.length,
      0
    );
    document.getElementById('playlistInfo').textContent =
      'Totale brani: ' + totalTracks;

    renderPages();
  }

  // Crea i pulsanti di paginazione
  function renderPages() {
    const p = document.getElementById('pages');
    p.innerHTML = '';
    pageTokens.forEach((tok, idx) => {
      const b = document.createElement('button');
      b.textContent = idx + 1;
      b.onclick = () => showPage(tok, idx);
      p.appendChild(b);
    });
    if (pageTokens.length) showPage(pageTokens[0], 0);
  }

  // Mostra i brani di una pagina
  function showPage(token, pageIndex) {
    const data = pageCache[token];
    const list = document.getElementById('tracksList');
    list.innerHTML = '';
    data.items.forEach((it, idx) => {
      const sn = it.snippet;
      if (!sn.resourceId) return;
      const vid = sn.resourceId.videoId;
      const div = document.createElement('div');
      div.className = 'track';
      div.textContent = `${pageIndex * MAX_RESULTS + idx + 1}. ${sn.title}`;
      div.dataset.videoId = vid;
      div.onclick = () => playVideo(vid, div);
      list.appendChild(div);
    });
  }

  // Riproduce un video gi√† caricato
  function playVideo(id, el) {
    document.querySelectorAll('.track').forEach(t =>
      t.classList.remove('active')
    );
    el.classList.add('active');
    if (player) {
      player.loadVideoById(id);
    }
  }

  // Callback globale YouTube IFrame API
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '200',
      width: '100%',
      playerVars: {
        controls: 0,
        enablejsapi: 1,
        origin: location.origin
      },
      events: {
        onReady: setupControls,
        onStateChange: e => {
          if (e.data === YT.PlayerState.ENDED && isRepeating) {
            player.playVideo();
          }
        },
        onError: e => {
          if ([101, 150, 153].includes(e.data)) playNext();
        }
      }
    });
  }

  // Configura i controlli Play/Pause/Prev/Next/Volume/Seek/Quality
  function setupControls() {
    document.getElementById('btnPlay').onclick = () => {
      const s = player.getPlayerState();
      s === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
    };
    document.getElementById('btnPrev').onclick = playPrev;
    document.getElementById('btnNext').onclick = playNext;
    document.getElementById('btnRepeat').onclick = () =>
      (isRepeating = !isRepeating);
    document.getElementById('btnShuffle').onclick = () =>
      (isShuffled = !isShuffled);
    document.getElementById('vol').oninput = e => {
      player.setVolume(e.target.value);
      document.getElementById('volLabel').textContent = e.target.value + '%';
    };
    document.getElementById('quality').onchange = e =>
      player.setPlaybackQuality(e.target.value);
    document.getElementById('seek').oninput = e => {
      const d = player.getDuration();
      player.seekTo((d * e.target.value) / 100, true);
    };
    setInterval(() => {
      try {
        const c = player.getCurrentTime();
        const d = player.getDuration();
        document.getElementById('seek').value = d ? (c / d) * 100 : 0;
        document.getElementById('timeLabel').textContent =
          `${formatTime(c)} / ${formatTime(d)}`;
      } catch {}
    }, 500);
  }

  // Skip automatico su errori embed
  function playNext() {
    const tracks = Array.from(document.querySelectorAll('.track'));
    const idx = tracks.findIndex(t => t.classList.contains('active'));
    if (idx >= 0 && idx < tracks.length - 1) tracks[idx + 1].click();
  }

  function playPrev() {
    const tracks = Array.from(document.querySelectorAll('.track'));
    const idx = tracks.findIndex(t => t.classList.contains('active'));
    if (idx > 0) tracks[idx - 1].click();
  }

  function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60).toString().padStart(2, '0');
    return `${m}:${sec}`;
  }

  // Binding del bottone Carica
  document.getElementById('loadBtn').onclick = loadPlaylist;

  // Carica l‚ÄôAPI YouTube IFrame
  (function() {
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.body.appendChild(tag);
  })();
</script>
</body>
</html>