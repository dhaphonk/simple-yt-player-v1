<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>simple-yt-player-v1</title>
  <style>
    html, body {
      margin:0; padding:0; height:100%;
      overflow:hidden;
      font-family:system-ui,Arial,sans-serif;
      background:#121212; color:#f0f0f0;
    }
    .wrap {
      height:100vh; max-width:1400px; margin:0 auto; padding:20px;
      display:grid; grid-template-columns:1fr 1fr; gap:40px;
      box-sizing:border-box;
    }
    header { grid-column:1/-1; text-align:center; margin-bottom:10px; position:relative; }
    h1 { margin:8px 0; font-size:2rem; color:#bb86fc; font-weight:600; }

    /* Switch stile Apple */
    .theme-toggle {
      position:absolute; top:10px; right:20px;
      display:flex; align-items:center; gap:6px;
    }
    .switch { position:relative; display:inline-block; width:50px; height:26px; }
    .switch input { display:none; }
    .slider {
      position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
      background-color:#444; transition:.4s; border-radius:34px;
    }
    .slider:before {
      position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px;
      background-color:white; transition:.4s; border-radius:50%;
    }
    input:checked + .slider { background-color:#bb86fc; }
    input:checked + .slider:before { transform:translateX(24px); }

    /* Tema chiaro */
    body.light { background:#f5f5f5; color:#222; }
    body.light .player { background:#ddd; }
    body.light .list { background:#fff; color:#000; }

    .player {
      background:#000; border-radius:12px; overflow:hidden;
      box-shadow:0 2px 12px rgba(0,0,0,0.5);
      margin-bottom:10px; width:90%; height:30vh;
      margin-left:auto; margin-right:auto;
    }
    .controls { margin:12px 0; display:flex; align-items:center; gap:14px; justify-content:center; }
    button {
      background:#1e1e1e; border:2px solid #333; border-radius:50%;
      width:48px; height:48px; display:flex; align-items:center; justify-content:center;
      color:#ddd; cursor:pointer; transition:all 0.2s ease;
      box-shadow:0 0 6px rgba(0,0,0,0.6);
    }
    button:hover { background:#2f2f2f; border-color:#555; color:#fff; }
    button.active { border-color:#bb86fc; background:#2a2250; color:#bb86fc; box-shadow:0 0 10px #bb86fc; }
    input[type=range]{padding:0;cursor:pointer}
    .list {
      margin-top:10px; overflow:auto; height:calc(100vh - 220px);
      font-size:1rem; border:1px solid #222; border-radius:10px;
      background:#181818; padding:10px;
    }
    .track { padding:8px 12px; cursor:pointer; border-bottom:1px solid #222; transition:background 0.15s; }
    .track:hover { background:#2a2a2a; }
    .track.active { background:#3a264d; }
    #timeRow, #volumeRow { display:flex; align-items:center; gap:10px; margin-top:6px; }
    #timeRow input, #volumeRow input { flex:1; }
    #timeLabel, #volLabel { font-size:0.9rem; color:#aaa; min-width:70px; text-align:right; }
    #loadingIndicator { display:none; }
    .spinner { animation: rotate 1s linear infinite; }
    .spinner .path {
      stroke: #bb86fc; stroke-linecap: round;
      animation: dash 1.5s ease-in-out infinite;
    }
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    @keyframes dash {
      0% { stroke-dasharray: 1,150; stroke-dashoffset: 0; }
      50% { stroke-dasharray: 90,150; stroke-dashoffset: -35; }
      100% { stroke-dasharray: 90,150; stroke-dashoffset: -124; }
    }
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>simple-yt-player-v1</h1>
      <div class="theme-toggle">
        üåû
        <label class="switch">
          <input type="checkbox" id="themeSwitch">
          <span class="slider"></span>
        </label>
        üåô
      </div>
    </header>

    <!-- Colonna sinistra: Player -->
    <div>
      <div class="player" id="player"></div>
      <div id="timeRow">
        <input id="seek" type="range" min="0" max="100" value="0">
        <span id="timeLabel">0:00 / 0:00</span>
      </div>
      <div class="controls">
        <button id="btnPrev" aria-label="Precedente">‚èÆ</button>
        <button id="btnPlay" aria-label="Play/Pausa">‚ñ∂Ô∏è</button>
        <button id="btnNext" aria-label="Successivo">‚è≠</button>
        <button id="btnShuffle" aria-label="Shuffle">üîÄ</button>
      </div>
      <div id="volumeRow">
        üîä <input id="vol" type="range" min="0" max="100" value="75">
        <span id="volLabel">75%</span>
      </div>
    </div>

    <!-- Colonna destra: Playlist -->
    <div>
      <div style="display:flex;gap:10px;margin-bottom:8px;align-items:center">
        <input id="playlistUrl" type="text" placeholder="Playlist URL..." style="flex:1;padding:10px;">
        <button id="loadBtn" aria-label="Carica Playlist">‚èè</button>
        <span id="loadingIndicator">
          <svg class="spinner" width="20" height="20" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"/>
          </svg>
        </span>
      </div>
      <div id="playlistTitle"></div>
      <div id="shuffleCounter" style="text-align:center;margin-top:4px;font-size:0.9rem;color:#bbb"></div>
      <div class="list" id="tracksList"></div>
    </div>
  </div>

<script>
const API_KEY = 'AIzaSyDDvrky0zFKo-Vs_HY5DaaVTrlXL397wz4';
const MAX_RESULTS = 50;
let playlistId=null, player=null, totalResults=0;
let shuffleEnabled=false;
let shuffleOrder=[], shuffleIndex=0;
let updateInterval=null;

function extractPlaylistId(str){
  try { const u=new URL(str); return u.searchParams.get('list'); }
  catch(e){ return null; }
}

function initShuffleOrder(){
  const tracks=document.querySelectorAll('#tracksList .track');
  shuffleOrder=Array.from(tracks.keys());
  for(let k=shuffleOrder.length-1;k>0;k--){
    const r=Math.floor(Math.random()*(k+1));
    [shuffleOrder[k], shuffleOrder[r]]=[shuffleOrder[r], shuffleOrder[k]];
  }
  shuffleIndex=0;
  updateShuffleCounter();
}
function playNextRandomUnique(){
  const tracks=document.querySelectorAll('#tracksList .track');
  if(shuffleOrder.length===0 || shuffleIndex>=shuffleOrder.length){ initShuffleOrder(); }
  const nextIndex=shuffleOrder[shuffleIndex++];
  tracks[nextIndex].click();
  updateShuffleCounter();
}

function updateShuffleCounter(){
  if(shuffleEnabled){
    document.getElementById('shuffleCounter').textContent =
      `Shuffle: ${shuffleIndex}/${totalResults}`;
  } else {
    document.getElementById('shuffleCounter').textContent = "";
  }
}

function getActiveTrack(){ return document.querySelector('.track.active'); }
function playNextfunction playNextSequential(){ 
  const a=getActiveTrack(); 
  a?.nextElementSibling?.click();
}

async function loadPlaylist(){
  playlistId=extractPlaylistId(document.getElementById('playlistUrl').value.trim());
  if(!playlistId)return alert('Playlist non valida');
  document.getElementById('loadingIndicator').style.display='inline';

  let allItems=[], seenIds=new Set(), pageToken='';
  try {
    do {
      const url=new URL('https://www.googleapis.com/youtube/v3/playlistItems');
      url.searchParams.set('part','snippet');
      url.searchParams.set('playlistId',playlistId);
      url.searchParams.set('maxResults',MAX_RESULTS);
      url.searchParams.set('key',API_KEY);
      if(pageToken)url.searchParams.set('pageToken',pageToken);

      const res=await fetch(url);
      const data=await res.json();
      if(data.error){ throw new Error(data.error.message); }

      (data.items||[]).forEach(it=>{
        const vid=it.snippet.resourceId.videoId;
        if(!seenIds.has(vid)){
          seenIds.add(vid);
          allItems.push(it);
        }
      });
      pageToken=data.nextPageToken||'';
    } while(pageToken);

    totalResults=allItems.length;
    document.getElementById('playlistTitle').textContent=`Totale: ${totalResults} brani`;

    const list=document.getElementById('tracksList');
    list.innerHTML='';
    allItems.forEach((it, idx) => {
      const vid = it.snippet.resourceId.videoId;
      const div = document.createElement('div');
      div.className = 'track';
      div.textContent = (idx+1) + ". " + it.snippet.title;
      div.dataset.videoId = vid;
      div.onclick = () => playVideo(vid, div);
      list.appendChild(div);
    });

    initShuffleOrder();
    updateShuffleCounter();
  } catch(err){
    alert("Errore nel caricamento playlist: " + err.message);
  } finally {
    document.getElementById('loadingIndicator').style.display='none';
  }
}

function playVideo(id,el){
  document.querySelectorAll('.track').forEach(t=>t.classList.remove('active'));
  if(el){
    el.classList.add('active');
    el.scrollIntoView({behavior:"smooth", block:"center"});
  }
  if(!player){
    player=new YT.Player('player',{
      width:'100%',height:'100%',videoId:id,
      playerVars:{controls:0,modestbranding:1,rel:0,origin:location.origin},
      events:{
        onReady:()=>{
          player.setPlaybackQuality('medium');
          if(!updateInterval){ updateInterval=setInterval(updateUI,500); }
        },
        onStateChange:(e)=>{
          player.setPlaybackQuality('medium');
          if(e.data === YT.PlayerState.ENDED){
            shuffleEnabled ? playNextRandomUnique() : playNextSequential();
          }
        },
        onError:e=>{
          if([101,150,153].includes(e.data)) el?.nextElementSibling?.click();
        }
      }
    });
  } else {
    player.loadVideoById(id);
    player.setPlaybackQuality('medium');
  }
}

function updateUI(){
  try{
    if(player){
      const c=player.getCurrentTime(),d=player.getDuration();
      document.getElementById('seek').value=d?c/d*100:0;
      document.getElementById('timeLabel').textContent=
        `${Math.floor(c/60)}:${String(Math.floor(c%60)).padStart(2,'0')} / ${Math.floor(d/60)}:${String(Math.floor(d%60)).padStart(2,'0')}`;
    }
  }catch{}
}

// Controlli
document.getElementById('btnPlay').onclick=()=>{
  if(!player)return;
  const s=player.getPlayerState();
  const icon=document.getElementById('iconPlay').firstElementChild;
  if(s===YT.PlayerState.PLAYING){
    player.pauseVideo();
    icon.setAttribute('d','M6 19h4V5H6zm8-14v14h4V5h-4z'); // pausa
  } else {
    player.playVideo();
    icon.setAttribute('d','M8 5v14l11-7z'); // play
  }
};
document.getElementById('btnPrev').onclick=()=>{ shuffleEnabled?playNextRandomUnique():playNextSequential(); };
document.getElementById('btnNext').onclick=()=>{ shuffleEnabled?playNextRandomUnique():playNextSequential(); };

document.getElementById('btnShuffle').onclick=()=>{
  shuffleEnabled=!shuffleEnabled;
  const btn=document.getElementById('btnShuffle');
  btn.classList.toggle('active', shuffleEnabled);
  btn.title = shuffleEnabled ? 'Shuffle ON: riproduzione casuale' : 'Shuffle OFF: riproduzione sequenziale';
  updateShuffleCounter();
};

document.getElementById('vol').oninput=e=>{
  if(player) player.setVolume(e.target.value);
  document.getElementById('volLabel').textContent=e.target.value+'%';
};
document.getElementById('seek').oninput=e=>{
  if(player){
    const d=player.getDuration();
    player.seekTo(d*e.target.value/100,true);
  }
};

document.getElementById('loadBtn').onclick=loadPlaylist;

// Toggle tema chiaro/scuro
document.getElementById('themeSwitch').onchange = (e)=>{
  if(e.target.checked){
    document.body.classList.add('light');
  } else {
    document.body.classList.remove('light');
  }
};

// Carica API YouTube
(function(){
  const tag=document.createElement('script');
  tag.src="https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
})();
</script>
</body>
</html>
