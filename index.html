<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>simple-yt-player-v1</title>
<style>
  body {
    margin:0; padding:0; height:100vh;
    font-family:system-ui,Arial,sans-serif;
    background:#121212; color:#f0f0f0;
    display:grid; grid-template-columns:3fr 2fr;
  }
  .playlist {
    border-right:1px solid #333;
    display:flex; flex-direction:column;
    padding:20px;
  }
  h2 { margin:0 0 10px; font-size:1.2rem; color:#bb86fc; }
  .playlist-input { display:flex; width:100%; margin-bottom:10px; }
  .playlist-input input {
    flex:1; padding:10px 12px;
    border:1px solid #333; border-right:none;
    border-radius:20px 0 0 20px;
    background:#1e1e1e; color:#eee;
  }
  .playlist-input button {
    width:48px; border:1px solid #333;
    border-radius:0 20px 20px 0;
    background:#bb86fc; color:#fff;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition:background 0.2s;
  }
  .playlist-input button:hover { background:#d0a6ff; }
  #tracksList {
    flex:1; overflow:auto; margin-top:10px;
    background:#181818; border-radius:8px; padding:10px;
  }
  .track { padding:8px; border-bottom:1px solid #222; cursor:pointer; }
  .track:hover { background:#2a2a2a; }
  .track.active { background:#3a264d; }
  #playlistTitle { margin-top:8px; font-size:0.95rem; color:#aaa; }
  #shuffleCounter { margin:4px 0; font-size:0.9rem; color:#bbb; }

  .player-area { display:flex; flex-direction:column; padding:20px; }
  #player {
    width:100%; height:360px;
    background:#000; border-radius:12px;
  }
  .controls-bar {
    display:flex; justify-content:center; gap:20px; margin-top:12px;
  }
  button {
    background:none; border:none; cursor:pointer;
    color:#f0f0f0; width:40px; height:40px;
  }
  button svg { width:100%; height:100%; fill:currentColor; }
  button.active { color:#bb86fc; }
</style>
</head>
<body>

<!-- Colonna sinistra: Playlist -->
<div class="playlist">
  <h2>Playlist</h2>
  <div class="playlist-input">
    <input id="playlistUrl" type="text" placeholder="Inserisci URL playlist YouTube...">
    <button id="loadBtn" aria-label="Naviga Playlist">
      <!-- Icona lente -->
      <svg viewBox="0 0 24 24" width="20" height="20"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 001.48-5.34C15.21 5.01 12.2 2 8.5 2S1.79 5.01 1.79 8.39c0 3.38 3.01 6.39 6.71 6.39 1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM8.5 13c-2.49 0-4.5-2.01-4.5-4.61S6.01 3.78 8.5 3.78 13 5.79 13 8.39 10.99 13 8.5 13z"/></svg>
    </button>
  </div>
  <div id="playlistTitle"></div>
  <div id="shuffleCounter"></div>
  <div id="tracksList"></div>
</div>

<!-- Colonna destra: Player -->
<div class="player-area">
  <div id="player"></div>
  <div class="controls-bar">
    <button id="btnShuffle" aria-label="Shuffle">
      <svg viewBox="0 0 24 24"><path d="M17 3h4v4h-2V5h-2V3zm0 14h2v-2h2v4h-4v-2zM3 5h6l7 7-7 7H3v-2h5.17L14 12 8.17 7H3V5z"/></svg>
    </button>
    <button id="btnLoop" aria-label="Loop">
      <svg viewBox="0 0 24 24"><path d="M17 17H7v-3l-4 4 4 4v-3h12a2 2 0 0 0 2-2V7h-2v10zM7 7h10v3l4-4-4-4v3H7a2 2 0 0 0-2 2v10h2V7z"/></svg>
    </button>
  </div>
</div>

<script>
const API_KEY = 'AIzaSyDDvrky0zFKo-Vs_HY5DaaVTrlXL397wz4';
let player=null, shuffleEnabled=false, loopEnabled=false;
let shuffleOrder=[], shuffleIndex=0, totalResults=0;

function extractPlaylistId(str){
  try { return new URL(str).searchParams.get('list'); }
  catch(e){ return null; }
}
function initShuffleOrder(){
  const tracks=document.querySelectorAll('#tracksList .track');
  shuffleOrder=Array.from(tracks.keys());
  for(let k=shuffleOrder.length-1;k>0;k--){
    const r=Math.floor(Math.random()*(k+1));
    [shuffleOrder[k], shuffleOrder[r]]=[shuffleOrder[r], shuffleOrder[k]];
  }
  shuffleIndex=0;
  updateShuffleCounter();
}
function playNextRandomUnique(){
  const tracks=document.querySelectorAll('#tracksList .track');
  if(shuffleOrder.length===0 || shuffleIndex>=shuffleOrder.length){ initShuffleOrder(); }
  const nextIndex=shuffleOrder[shuffleIndex++];
  tracks[nextIndex].click();
  updateShuffleCounter();
}
function updateShuffleCounter(){
  document.getElementById('shuffleCounter').textContent =
    shuffleEnabled ? `Shuffle: ${shuffleIndex}/${totalResults}` : "";
}
function getActiveTrack(){ return document.querySelector('.track.active'); }
function playNextSequential(){ getActiveTrack()?.nextElementSibling?.click(); }

async function loadPlaylist(){
  const pid=extractPlaylistId(document.getElementById('playlistUrl').value.trim());
  if(!pid)return alert('Playlist non valida');
  let allItems=[], seen=new Set(), pageToken='';
  try {
    do {
      const url=new URL('https://www.googleapis.com/youtube/v3/playlistItems');
      url.searchParams.set('part','snippet');
      url.searchParams.set('playlistId',pid);
      url.searchParams.set('maxResults',50);
      url.searchParams.set('key',API_KEY);
      if(pageToken)url.searchParams.set('pageToken',pageToken);
      const res=await fetch(url); const data=await res.json();
      if(data.error) throw new Error(data.error.message);
      (data.items||[]).forEach(it=>{
        const vid=it.snippet.resourceId.videoId;
        if(!seen.has(vid)){ seen.add(vid); allItems.push(it); }
      });
      pageToken=data.nextPageToken||'';
    } while(pageToken);
    totalResults=allItems.length;
    document.getElementById('playlistTitle').textContent=`Totale: ${totalResults} brani`;
    const list=document.getElementById('tracksList'); list.innerHTML='';
    allItems.forEach((it, idx)=>{
      const vid=it.snippet.resourceId.videoId;
      const div=document.createElement('div');
      div.className='track'; div.textContent=(idx+1)+". "+it.snippet.title;
      div.onclick=()=>playVideo(vid,div);
      list.appendChild(div);
    });
    initShuffleOrder();
  } catch(err){ alert("Errore: "+err.message); }
}

function playVideo(id,el){
  document.querySelectorAll('.track').forEach(t=>t.classList.remove('active'));
  if(el)function playVideo(id, el) {
  // reset evidenziazione
  document.querySelectorAll('.track').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');

  if (!player) {
    player = new YT.Player('player', {
      width: '100%',
      height: '100%',
      videoId: id,   // ✅ proprietà corretta
      playerVars: {
        controls: 1,          // comandi nativi YouTube visibili
        modestbranding: 1,
        rel: 0,
        origin: location.origin
      },
      events: {
        onReady: () => {
          try { player.setPlaybackQuality('medium'); } catch {}
        },
        onStateChange: (e) => {
          try { player.setPlaybackQuality('medium'); } catch {}
          if (e.data === YT.PlayerState.ENDED) {
            if (loopEnabled) {
              playVideo(id, el);
            } else if (shuffleEnabled) {
              playNextRandomUnique();
            } else {
              playNextSequential();
            }
          }
        }
      }
    });
  } else {
    player.loadVideoById(id);
    try { player.setPlaybackQuality('medium'); } catch {}
  }
}

// Bottoni esterni
document.getElementById('btnShuffle').onclick = () => {
  shuffleEnabled = !shuffleEnabled;
  document.getElementById('btnShuffle').classList.toggle('active', shuffleEnabled);
  updateShuffleCounter();
};
document.getElementById('btnLoop').onclick = () => {
  loopEnabled = !loopEnabled;
  document.getElementById('btnLoop').classList.toggle('active', loopEnabled);
};

document.getElementById('loadBtn').onclick = loadPlaylist;

// Carica API YouTube
(function(){
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
})();
</script>
</body>
</html>
