<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dark Playlist Player - Debug</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
  .container { display:flex; height:100vh; }
  .left-panel { flex:1; background:#1a1a1a; padding:20px; box-sizing:border-box; display:flex; flex-direction:column; }
  .right-panel { flex:2; background:#181818; padding:20px; box-sizing:border-box; overflow-y:auto; }
  #player { width:100%; height:200px; background:#000; margin-bottom:20px; }
  input, select { width:100%; padding:8px; margin-bottom:10px; background:#1e1e1e; color:#fff; border:1px solid #333; border-radius:6px; }
  .controls { display:flex; justify-content:space-around; margin:10px 0; }
  .controls button {
    background-color: #7a3cff;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(122, 60, 255, 0.6);
    transition: background-color 0.2s ease, box-shadow 0.2s ease;
  }
  .controls button:hover {
    background-color: #5e2fcc;
    box-shadow: 0 0 12px rgba(122, 60, 255, 0.9);
  }
  .volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
  }
  .volume-control i { font-size: 18px; color: #fff; }
  .volume-control input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: #333;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
  }
  .volume-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #7a3cff;
    box-shadow: 0 0 6px rgba(122, 60, 255, 0.8);
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .volume-control input[type="range"]::-webkit-slider-thumb:hover {
    background: #5e2fcc;
  }
  .volume-control span { min-width: 40px; text-align: right; }
  .playlist-item { padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .playlist-item:hover { background:#2a2a2a; }
  .track-info { display:flex; flex-direction:column; }
  .track-number { color:#aaa; font-size:12px; }
  .muted { color:#aaa; font-size:12px; }
</style>
</head>
<body>

<div class="container">
  <div class="left-panel">
    <div id="player"></div>
    <input id="playlistUrl" placeholder="Incolla il link della playlist">
    <div class="controls">
      <button id="prevBtn" title="Precedente"><i class="fa-solid fa-backward-step"></i></button>
      <button id="playBtn" title="Play/Pausa"><i class="fa-solid fa-play"></i></button>
      <button id="nextBtn" title="Successivo"><i class="fa-solid fa-forward-step"></i></button>
      <button id="shuffleBtn" title="Shuffle"><i class="fa-solid fa-shuffle"></i></button>
      <button id="compactBtn" title="Modalit√† compatta"><i class="fa-solid fa-minimize"></i></button>
      <button id="audioBtn" title="Solo audio"><i class="fa-solid fa-headphones"></i></button>
    </div>
    <label>Risoluzione:</label>
    <select id="quality">
      <option value="small">240p</option>
      <option value="medium" selected>360p</option>
      <option value="hd720">720p</option>
      <option value="hd1080">1080p</option>
    </select>
    <div class="volume-control">
      <i id="volumeIcon" class="fa-solid fa-volume-high"></i>
      <input id="volSlider" type="range" min="0" max="100" value="100" step="1">
      <span id="volPercent">100%</span>
    </div>
    <button id="loadBtn">Carica Playlist</button>
    <div id="status" class="muted"></div>
  </div>

  <div class="right-panel" id="playlistInfo"></div>
</div>

<script>
  const apiKey = "AIzaSyDDvrky0zFKo-Vs_HY5DaaVTrlXL397wz4"; // <-- INSERISCI QUI LA TUA API KEY
  let player, playlistId = "", shuffle = false, savedQuality = "medium";
  let compactMode = false, audioOnlyMode = false;

  (function loadYT() {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  })();

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '200',
      width: '100%',
      playerVars: { modestbranding: 1, rel: 0, playsinline: 1, enablejsapi: 1, origin: location.origin },
      events: { onReady: onPlayerReady }
    });
  }

  function onPlayerReady() {
    player.setPlaybackQuality(savedQuality);
    player.setVolume(100);
    console.log("‚úÖ Player pronto");
  }

  function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
  function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  document.getElementById('loadBtn').addEventListener('click', loadPlaylist);
  document.getElementById('prevBtn').addEventListener('click', () => player.previousVideo());
  document.getElementById('nextBtn').addEventListener('click', () => player.nextVideo());
  document.getElementById('shuffleBtn').addEventListener('click', () => { shuffle = !shuffle; console.log("üîÄ Shuffle:", shuffle); });
  document.getElementById('compactBtn').addEventListener('click', () => {
    compactMode = !compactMode;
    document.getElementById('player').style.height = compactMode ? "100px" : "200px";
  });
  document.getElementById('audioBtn').addEventListener('click', () => {
    audioOnlyMode = !audioOnlyMode;
    document.getElementById('player').style.display = audioOnlyMode ? "none" : "block";
  });
  document.getElementById('quality').addEventListener('change', e => {
    savedQuality = e.target.value;
    player.setPlaybackQuality(savedQuality);
  });
  document.getElementById('volSlider').addEventListener('input', e => {
    const v = +e.target.value;
    player.setVolume(v);
    document.getElementById('volPercent').innerText = v + "%";
    const icon = document.getElementById('volumeIcon');
    icon.className = "fa-solid";
    if (v === 0) icon.classList.add('fa-volume-xmark');
    else if (v > 0 && v <= 30) icon.classList.add('fa-volume-off');
    else if (v > 30 && v <= 70) icon.classList.add('fa-volume-low');
    else icon.classList.add('fa-volume-high');
  });
  document.getElementById('playBtn').addEventListener('click', () => {
    const icon = document.querySelector('#playBtn i');
    if (player.getPlayerState() === YT.PlayerState.PLAYING)
    if (player.getPlayerState() === YT.PlayerState.PLAYING) {
      player.pauseVideo();
      icon.classList.replace('fa-pause', 'fa-play');
      console.log("‚è∏ Video in pausa");
    } else {
      player.playVideo();
      icon.classList.replace('fa-play', 'fa-pause');
      console.log("‚ñ∂ Video in riproduzione");
    }
  });

  async function loadPlaylist() {
    setStatus("");
    const url = document.getElementById('playlistUrl').value.trim();
    const idMatch = url.match(/[?&]list=([a-zA-Z0-9_-]+)/);
    if (!idMatch) { 
      setStatus("Link playlist non valido."); 
      console.error("‚ùå Playlist URL non valido:", url);
      return; 
    }
    playlistId = idMatch[1];
    console.log("üìã Playlist ID estratto:", playlistId);

    try {
      const items = await fetchAllPlaylistItems(playlistId);
      console.log("üì¶ Video totali trovati:", items.length);

      const videoIds = items.map(i => i.contentDetails.videoId).filter(Boolean);
      const meta = await fetchVideosMeta(videoIds);

      const filteredIds = videoIds.filter(id => meta[id]?.embeddable);
      console.log("‚úÖ Video embeddabili:", filteredIds.length);

      if (shuffle) shuffleArray(filteredIds);

      if (filteredIds.length > 0) {
        player.loadPlaylist({ playlist: filteredIds, index: 0 });
        renderPlaylistUI(items, meta);
        setStatus(`Caricati ${filteredIds.length} video embeddabili su ${videoIds.length}`);
      } else {
        setStatus("Nessun video embeddabile trovato.");
        console.warn("‚ö† Playlist vuota dopo il filtro embeddable");
      }
    } catch (err) {
      console.error("‚ùå Errore durante il caricamento playlist:", err);
      setStatus("Errore nel caricamento della playlist. Controlla API key e privacy.");
    }
  }

  async function fetchAllPlaylistItems(id) {
    let pageToken = "", items = [];
    while (true) {
      const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=50&playlistId=${id}&key=${apiKey}${pageToken ? `&pageToken=${pageToken}` : ""}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.error) {
        console.error("‚ùå Errore API playlistItems:", data.error);
        break;
      }
      if (!data.items) break;
      items.push(...data.items);
      if (!data.nextPageToken) break;
      pageToken = data.nextPageToken;
    }
    return items;
  }

  async function fetchVideosMeta(videoIds) {
    const out = {};
    for (let i = 0; i < videoIds.length; i += 50) {
      const batch = videoIds.slice(i, i + 50).join(',');
      const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,status&id=${batch}&key=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.error) {
        console.error("‚ùå Errore API videos:", data.error);
        continue;
      }
      (data.items || []).forEach(v => {
        const id = v.id;
        const status = v.status || {};
        const contentDetails = v.contentDetails || {};
        out[id] = {
          embeddable: !!status.embeddable,
          duration: formatDuration(contentDetails.duration)
        };
      });
    }
    return out;
  }

  function formatDuration(iso) {
    const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    const h = +(m?.[1] || 0), min = +(m?.[2] || 0), s = +(m?.[3] || 0);
    const hh = h > 0 ? h + ":" : "";
    return hh + String(min).padStart(2, '0') + ":" + String(s).padStart(2, '0');
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function renderPlaylistUI(items, meta) {
    const container = document.getElementById('playlistInfo');
    container.innerHTML = '';
    items.forEach((item, idx) => {
      const id = item.contentDetails.videoId;
      const title = item.snippet.title;
      const duration = meta[id]?.duration || '';
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.innerHTML = `
        <div class="track-info">
          <strong>${escapeHtml(title)}</strong>
          <span class="track-number">#${idx + 1}</span>
        </div>
        <span>${duration}</span>
      `;
      div.addEventListener('click', () => {
        const current = player.getPlaylist() || [];
        const pos = current.indexOf(id);
        if (pos >= 0) {
          console.log("üéµ Salto al video:", title, "(posizione", pos, ")");
          player.playVideoAt(pos);
        }
      });
      container.appendChild(div);
    });
  }
</script>

</body>
</html>
